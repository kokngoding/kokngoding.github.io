<!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.

 v2.0
 https://github.com/cotes2020/jekyll-theme-chirpy
 Â© 2019 Cotes Chung
 Published under the MIT License
-->

<!-- The total size of related posts  -->
{% assign TOTAL_SIZE = 3 %}

<!-- An random integer that bigger than 0  -->
{% assign TAG_SCORE = 1 %}

<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->
{% assign CATEGORY_SCORE = 0.5 %}

{% assign SEPARATOR = ":" %}

{% assign score_list = "" | split: "" %}
{% assign last_index = site.posts.size | minus: 1 %}

{% for i in (0..last_index) %}
  {% assign post = site.posts[i] %}

  {% if post.url == page.url %}
    {% continue %}
  {% endif %}

  {% assign score = 0 %}

  {% for tag in post.tags %}
    {% if page.tags contains tag %}
      {% assign score = score | plus: TAG_SCORE %}
    {% endif %}
  {% endfor %}

  {% for category in post.categories %}
    {% if page.categories contains category %}
      {% assign score = score | plus: CATEGORY_SCORE %}
    {% endif %}
  {% endfor %}

  {% if score > 0 %}
    {% capture score_item %}{{ score }}{{ SEPARATOR }}{{ i }}{% endcapture %}
    {% assign score_list = score_list | push: score_item %}
  {% endif %}

{% endfor %}


{% assign index_list = "" | split: "" %}

{% if score_list.size > 0 %}
  {% assign score_list = score_list | sort | reverse %}
  {% for entry in score_list limit: TOTAL_SIZE %}
    {% assign index = entry | split: SEPARATOR | last %}
    {% assign index_list = index_list | push: index %}
  {% endfor %}
{% endif %}

<!-- Fill with the other newlest posts  -->
{% assign less = TOTAL_SIZE | minus: index_list.size %}

{% if less > 0 %}

  {% for i in (0..last_index) %}
    {% assign post = site.posts[i] %}
    {% if post.url != page.url  %}
      {% capture cur_index %}{{ i }}{% endcapture %}
      {% unless index_list contains cur_index %}
        {% assign index_list = index_list | push: cur_index %}
        {% assign less = less | minus: 1 %}
        {% if less <= 0 %}
          {% break %}
        {% endif %}
      {% endunless %}
    {% endif %}
  {% endfor %}

{% endif %}

{% if index_list.size > 0 %}
  <div id="related-posts" class="mt-3 mb-2 mb-sm-4">
    <h5 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Related Post :</h5>
    <div class="row card-deck mb-4">
    {% for entry in index_list %}
      {% assign index = entry | plus: 0 %}
      {% assign post = site.posts[index] %}
      <div class="col-md-4 col-sm-4">
        <div class="rounded shadow">
          <a href="{{ site.baseurl }}{{ post.url }}"  class="bg-light rounded">
              {% if post.image %}

                  {% if site.lazyimages == "enabled" %}
                      <img class="img-fluid lazyimg" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="{% if post.image contains "://" %}{{ post.image }}{% else %}{{ site.baseurl }}/{{ post.image }}{% endif %}" alt="{{ post.title }}">
                  {% else %}
                      <img class="img-fluid rounded-top" src="{% if post.image contains "://" %}{{ post.image }}{% else %}{{ site.baseurl }}/{{ post.image }}{% endif %}" alt="{{ post.title }}"> 
                  {% endif %}

              {% endif %}
              <h6 class="mx-2 my-2">{{ post.title }}</h6>
              <p class="small mx-2 pb-1">{{ post.date | date_to_string }}</p>
          </a>
        </div>
      </div>
    {% endfor %}
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->
{% endif %}
